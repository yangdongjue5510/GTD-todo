.PHONY: help generate test-unit test-coverage test-acceptance build clean coverage-html test-verbose ci

# Variables
BINARY_NAME=gtd-todo
BUILD_DIR=bin
COVERAGE_FILE=coverage.out
COVERAGE_HTML=coverage.html
COVERAGE_THRESHOLD=80

# Default target
all: ci

# Help target
help:
	@echo "Available targets:"
	@echo "  generate        Generate mock files"
	@echo "  test-unit       Run unit tests with coverage"
	@echo "  test-coverage   Run unit tests and verify 80%+ coverage"
	@echo "  test-acceptance Run acceptance tests"
	@echo "  build          Build the application"
	@echo "  clean          Clean build artifacts"
	@echo "  coverage-html   Generate HTML coverage report"
	@echo "  test-verbose    Run tests with verbose output"
	@echo "  ci             Run full CI pipeline"

# Generate mock files
generate:
	@echo "ðŸ”„ Generating mock files..."
	go generate ./...
	@echo "âœ… Mock generation completed"

# Run unit tests with coverage (excluding mock files)
test-unit:
	@echo "ðŸ§ª Running unit tests with coverage..."
	go test -coverprofile=$(COVERAGE_FILE) ./...
	@echo "ðŸ§¹ Removing mock files from coverage..."
	@awk '!/mock_.*\.go:/' $(COVERAGE_FILE) > $(COVERAGE_FILE).tmp && mv $(COVERAGE_FILE).tmp $(COVERAGE_FILE)
	@echo "âœ… Unit tests completed"

# Verify coverage threshold (excluding mocks)
test-coverage: test-unit
	@echo "ðŸ“Š Checking coverage threshold ($(COVERAGE_THRESHOLD)%)..."
	@total_coverage=$$(go tool cover -func=$(COVERAGE_FILE) | grep "total:" | awk '{print $$3}' | sed 's/%//'); \
	echo "Overall coverage: $${total_coverage}%"; \
	if [ $$(echo "$${total_coverage} < $(COVERAGE_THRESHOLD)" | bc -l) -eq 1 ]; then \
		echo "âŒ Coverage $${total_coverage}% is below $(COVERAGE_THRESHOLD)%"; \
		exit 1; \
	else \
		echo "âœ… Coverage $${total_coverage}% meets requirement ($(COVERAGE_THRESHOLD)%+)"; \
	fi

# Run acceptance tests
test-acceptance:
	@echo "ðŸŽ¯ Running acceptance tests..."
	go test -tags=acceptance ./tests/acceptance/...
	@echo "âœ… Acceptance tests completed"

# Build the application
build:
	@echo "ðŸ”¨ Building application..."
	mkdir -p $(BUILD_DIR)
	go build -o $(BUILD_DIR)/$(BINARY_NAME) .
	@echo "âœ… Build completed: $(BUILD_DIR)/$(BINARY_NAME)"

# Clean build artifacts
clean:
	@echo "ðŸ§¹ Cleaning build artifacts..."
	rm -rf $(BUILD_DIR)
	rm -f $(COVERAGE_FILE) $(COVERAGE_HTML)
	@echo "âœ… Clean completed"

# Generate HTML coverage report
coverage-html: test-unit
	@echo "ðŸ“‹ Generating HTML coverage report..."
	go tool cover -html=$(COVERAGE_FILE) -o $(COVERAGE_HTML)
	@echo "âœ… Coverage report generated: $(COVERAGE_HTML)"

# Run tests with verbose output
test-verbose:
	@echo "ðŸ” Running tests with verbose output..."
	go test -v ./...
	@echo "âœ… Verbose tests completed"

# Full CI pipeline
ci: generate test-coverage test-acceptance build
	@echo "ðŸŽ‰ CI pipeline completed successfully!"